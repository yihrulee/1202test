<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…§åˆ†æ³Œå”èª¿é«˜æ‰‹</title>
    <style>
        /* å…¨å±€è¨­å®š */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #263238; color: white; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; height: 100vh; box-sizing: border-box; }
        
        /* 1. é ‚éƒ¨è³‡è¨Šåˆ— */
        .header-bar {
            flex: 0 0 auto;
            display: flex; justify-content: space-between; width: 95%; max-width: 1200px;
            background: #37474f; padding: 10px 30px; border-radius: 10px;
            margin-bottom: 10px; border: 1px solid #546e7a;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .score-val { color: #ffeb3b; font-size: 28px; font-family: monospace; font-weight: 900; }
        .time-val { color: #ff5252; font-size: 28px; font-family: monospace; font-weight: 900; }

        /* 2. éŠæˆ²ä¸»å®¹å™¨ */
        .game-container { 
            flex: 1; display: flex; gap: 15px; width: 98%; max-width: 1200px; overflow: hidden; 
        }
        
        /* å·¦å´ï¼šæ•¸å€¼ç›£æ§ */
        .status-panel { 
            flex: 0 0 180px; 
            display: flex; flex-direction: column; justify-content: center; gap: 10px; 
            background: #37474f; padding: 10px; border-radius: 10px;
        }
        .status-item { background: #455a64; padding: 8px; border-radius: 8px; border: 1px solid #607d8b; }
        .label { font-weight: bold; font-size: 14px; margin-bottom: 4px; display: block; color: #cfd8dc; }
        .progress-bg { background: #263238; height: 15px; border-radius: 10px; overflow: hidden; border: 1px solid #546e7a; }
        .progress-fill { height: 100%; width: 50%; transition: width 0.2s, background-color 0.2s; }

        /* ä¸­é–“èˆå° */
        .center-stage { 
            flex: 1; 
            background-color: #eceff1; 
            border-radius: 15px; 
            display: flex; flex-direction: column; 
            overflow: hidden; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        /* [ä¸Š] äº‹ä»¶å€ (å«å€’æ•¸æ¢) */
        .event-section {
            flex: 0 0 110px; 
            background: #fff; border-bottom: 2px solid #ddd;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 5; position: relative;
        }
        .event-title { font-size: 32px; font-weight: 900; color: #333; margin: 0; }
        .event-desc { font-size: 20px; color: #d84315; margin-top: 5px; font-weight: bold; }
        
        /* 5ç§’å€’æ•¸æ¢ */
        .timer-bar-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 8px; background: #ddd; }
        .timer-bar-fill { height: 100%; width: 100%; background: #ff1744; transition: width linear; }

        /* [ä¸­] äººé«”å€ */
        .body-section {
            flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
            background: #fafafa;
        }
        .body-outline { position: relative; width: 220px; height: 460px; transform: scale(0.95); }
        
        .head { width: 65px; height: 75px; background: #ffe0bd; border-radius: 30px; position: absolute; top: 0; left: 78px; border: 3px solid #333; }
        .torso { width: 90px; height: 190px; background: #ffe0bd; border-radius: 15px; position: absolute; top: 80px; left: 65px; border: 3px solid #333; }
        .arm-l { width: 25px; height: 160px; background: #ffe0bd; position: absolute; top: 85px; left: 35px; border-radius: 10px; transform: rotate(12deg); border: 3px solid #333; }
        .arm-r { width: 25px; height: 160px; background: #ffe0bd; position: absolute; top: 85px; left: 160px; border-radius: 10px; transform: rotate(-12deg); border: 3px solid #333; }
        .leg-l { width: 35px; height: 200px; background: #ffe0bd; position: absolute; top: 275px; left: 65px; border-radius: 10px; border: 3px solid #333; }
        .leg-r { width: 35px; height: 200px; background: #ffe0bd; position: absolute; top: 275px; left: 120px; border-radius: 10px; border: 3px solid #333; }

        .gland-btn { position: absolute; width: 45px; height: 45px; background: #ff1744; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 100; font-size: 20px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; transition: transform 0.1s; }
        .gland-btn:hover { transform: scale(1.1); background: #d50000; }
        .gland-btn:active { transform: scale(0.9); }
        
        #btn-pituitary { top: 15px; left: 88px; background: #aa00ff; } 
        #btn-thyroid { top: 85px; left: 88px; background: #00bcd4; } 
        #btn-parathyroid { top: 85px; left: 125px; width: 25px; height: 25px; background: #ff6d00; font-size: 12px; } 
        #btn-adrenal { top: 165px; left: 75px; background: #f44336; } 
        #btn-pancreas { top: 195px; left: 105px; background: #00c853; } 

        /* [ä¸‹] å›ºå®šæ“ä½œé¢æ¿ */
        .control-panel {
            flex: 0 0 100px; background: #263238;
            border-top: 4px solid #ffeb3b;
            display: flex; justify-content: center; align-items: center;
            padding: 10px; z-index: 20;
        }
        
        .placeholder-text { color: #78909c; font-size: 24px; font-weight: bold; }
        
        .hormone-btn { 
            flex: 1; height: 70px; margin: 0 5px; 
            background: white; color: #333; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 20px; font-weight: bold; 
            box-shadow: 0 4px 0 #999; display: flex; justify-content: center; align-items: center;
        }
        .hormone-btn:active { transform: translateY(4px); box-shadow: none; }
        .hormone-btn.blue { background: #40c4ff; color: #000; }
        .hormone-btn.green { background: #69f0ae; color: #000; }
        .hormone-btn.orange { background: #ffd740; color: #000; }

        /* ç‰¹æ•ˆ */
        .score-popup { position: absolute; font-size: 100px; font-weight: 900; color: #ffeb3b; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; z-index: 200; text-shadow: 4px 4px 0 #000; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column; color: white; text-align: center; }
        .hidden { display: none; }
        .start-btn { padding: 25px 80px; font-size: 40px; background: #ff1744; color: white; border: none; border-radius: 60px; cursor: pointer; margin-top: 30px; font-weight: bold; animation: pulse 1s infinite; }

        @keyframes floatUp { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5); } }
        .score-anim { animation: floatUp 0.8s ease-out forwards; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- [æ–°å¢] æ­¥é©Ÿèªªæ˜æ¨£å¼ --- */
        .step-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; width: 140px; border: 1px solid rgba(255,255,255,0.2); transition: transform 0.2s; }
        .step-box:hover { transform: translateY(-5px); background: rgba(255,255,255,0.2); }
        .step-icon { font-size: 40px; margin-bottom: 5px; }
        .step-title { font-weight: bold; font-size: 22px; color: #40c4ff; margin-bottom: 5px; }
        .step-desc { font-size: 15px; color: #eceff1; }
        .arrow-icon { font-size: 30px; color: #607d8b; display: flex; align-items: center; }

    </style>
</head>
<body>

    <div class="header-bar">
        <div class="score-val">SCORE: <span id="score-display">0</span></div>
        <div class="time-val">TIME: <span id="timer-display">90</span></div>
    </div>

    <div class="game-container">
        <div class="status-panel">
            <div class="status-item">
                <span class="label">è¡€ç³– Sugar</span>
                <div class="progress-bg"><div id="bar-sugar" class="progress-fill"></div></div>
            </div>
            <div class="status-item">
                <span class="label">å¿ƒè·³ Heart</span>
                <div class="progress-bg"><div id="bar-heart" class="progress-fill"></div></div>
            </div>
            <div class="status-item">
                <span class="label">è¡€éˆ£ Calcium</span>
                <div class="progress-bg"><div id="bar-calcium" class="progress-fill"></div></div>
            </div>
            <div class="status-item">
                <span class="label">ç”Ÿé•· Growth</span>
                <div class="progress-bg"><div id="bar-growth" class="progress-fill"></div></div>
            </div>
            <div style="margin-top:20px; color:#cfd8dc; text-align:center; font-size:16px; border:1px solid #555; padding:10px; border-radius:5px;">
                âš¡ <strong>é«˜æ‰‹è¦å‰‡ï¼š</strong><br>
                1. åªæœ‰ä¸€æ¬¡æ©Ÿæœƒ<br>
                2. ç­”éŒ¯ç›´æ¥ä¸‹ä¸€é¡Œ<br>
                3. <span style="color:#ff5252; font-weight:bold;">å¤±æ•—æ‰£ 500 åˆ†ï¼</span>
            </div>
        </div>

        <div class="center-stage">
            
            <div id="event-section" class="event-section">
                <h2 id="event-title" class="event-title">æº–å‚™...</h2>
                <p id="event-desc" class="event-desc">5ç§’é™æ™‚åå°„æŒ‘æˆ°</p>
                <div class="timer-bar-bg"><div id="timer-bar" class="timer-bar-fill"></div></div>
            </div>
            
            <div class="body-section">
                <div id="score-popup" class="score-popup">+1000</div>
                <div class="body-outline">
                    <div class="head"></div><div class="torso"></div><div class="arm-l"></div><div class="arm-r"></div><div class="leg-l"></div><div class="leg-r"></div>
                    <div id="btn-pituitary" class="gland-btn" onclick="selectGland('pituitary')">è…¦</div>
                    <div id="btn-thyroid" class="gland-btn" onclick="selectGland('thyroid')">ç”²</div>
                    <div id="btn-parathyroid" class="gland-btn" onclick="selectGland('parathyroid')">å‰¯</div>
                    <div id="btn-adrenal" class="gland-btn" onclick="selectGland('adrenal')">è…</div>
                    <div id="btn-pancreas" class="gland-btn" onclick="selectGland('pancreas')">èƒ°</div>
                </div>
            </div>

            <div id="control-panel" class="control-panel">
                <div id="placeholder" class="placeholder-text">ğŸ”´ è«‹å…ˆé»æ“Šéƒ¨ä½(åœ“é»)</div>
                <div id="action-buttons" style="display:none; width:100%; display:flex; gap:10px;"></div>
            </div>
        </div>
    </div>

    <div id="overlay" class="overlay">
        <h1 style="font-size: 50px; color: #ffeb3b; margin:0 0 10px 0;">å…§åˆ†æ³Œå”èª¿é«˜æ‰‹</h1>
        
        <div style="display:flex; justify-content:center; gap:15px; margin: 25px 0;">
            <div class="step-box">
                <div class="step-icon">ğŸ‘€</div>
                <div class="step-title">1.çœ‹é¡Œç›®</div>
                <div class="step-desc">ç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ</div>
            </div>
            <div class="arrow-icon">â¡</div>
            <div class="step-box">
                <div class="step-icon">ğŸ‘†</div>
                <div class="step-title">2.é»å™¨å®˜</div>
                <div class="step-desc">é»æ“Šå°æ‡‰åœ“é»</div>
            </div>
            <div class="arrow-icon">â¡</div>
            <div class="step-box">
                <div class="step-icon">ğŸ’Š</div>
                <div class="step-title">3.é¸æ¿€ç´ </div>
                <div class="step-desc">é¸æ“‡æ­£ç¢ºæ¿€ç´ </div>
            </div>
        </div>

        <p style="font-size: 20px; color: #b0bec5;">90 ç§’æ¥µé€ŸæŒ‘æˆ°ãƒ»ç­”éŒ¯æ‰£ 500 åˆ†</p>
        <button class="start-btn" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <script>
        let stats = { sugar: 50, heart: 50, calcium: 50, growth: 50 };
        let score = 0;
        let timeLeft = 90;
        let gameActive = false;
        let gameLoopTimer = null;
        let eventTimeoutTimer = null; 
        let processingTurn = false; // é˜²é€£é»é–å®š
        
        let currentEvent = null;
        let eventStartTime = 0;
        let eventTimeLimit = 5000; 

        const eventsDB = [
            { id: 1, title: "ğŸ” åƒå¤§é¤ï¼", desc: "è¡€ç³–é£†å‡ (+40)", type: "sugar_high", target: "insulin", effect: {sugar: 40} },
            { id: 2, title: "ğŸ• è¢«ç‹—è¿½ï¼", desc: "èƒ½é‡è€—ç›¡ (-40)", type: "danger", target: "adrenaline", effect: {heart: -40, sugar: -20} },
            { id: 3, title: "ğŸ¥´ é¤“æ˜äº†ï¼", desc: "è¡€ç³–æš´è·Œ (-40)", type: "sugar_low", target: "glucagon", effect: {sugar: -40} },
            { id: 4, title: "âš¡ å¤§æŠ½ç­‹ï¼", desc: "è¡€éˆ£ä¸è¶³ (-40)", type: "cramp", target: "parathormone", effect: {calcium: -40} },
            { id: 5, title: "ğŸ“‰ å£“åŠ›å¤§ï¼", desc: "å¿ƒè·³é©Ÿé™ (-30)", type: "stress", target: "adrenaline", effect: {heart: -30, sugar: -10} },
            { id: 6, title: "ğŸŒ± é•·ä¸é«˜ï¼", desc: "ç”Ÿé•·åœæ»¯ (-30)", type: "growth", target: "growth", effect: {growth: -30} }
        ];

        function updateDisplay() {
            for (let key in stats) {
                let val = stats[key];
                if (val < 0) val = 0; if (val > 100) val = 100;
                stats[key] = val;
                
                let bar = document.getElementById(`bar-${key}`);
                bar.style.width = val + "%";
                if (val < 30 || val > 70) bar.style.background = "#ff1744"; 
                else bar.style.background = "#00e676";
            }
            document.getElementById("score-display").innerText = score;
            document.getElementById("timer-display").innerText = timeLeft;
        }

        function startGame() {
            stats = { sugar: 50, heart: 50, calcium: 50, growth: 50 };
            score = 0;
            timeLeft = 90; 
            gameActive = true;
            processingTurn = false;
            
            document.getElementById("overlay").classList.add("hidden");
            updateDisplay();

            clearInterval(gameLoopTimer);
            gameLoopTimer = setInterval(gameLoop, 1000);
            
            triggerNewEvent();
        }

        function gameLoop() {
            if (!gameActive) return;
            timeLeft--;
            if (timeLeft <= 0) { endGame(); return; }
            updateDisplay();
        }

        function triggerNewEvent() {
            if (!gameActive) return;
            
            processingTurn = false; // è§£é–
            clearTimeout(eventTimeoutTimer);
            
            // é‡ç½®å€’æ•¸æ¢ (å¼·åˆ¶ç„¡å‹•ç•«é‡ç½®)
            let timerBar = document.getElementById("timer-bar");
            timerBar.style.transition = "none";
            timerBar.style.width = "100%";
            void timerBar.offsetWidth; // å¼·åˆ¶é‡ç¹ª
            
            // éš¨æ©Ÿå‡ºé¡Œ
            let randIndex = Math.floor(Math.random() * eventsDB.length);
            currentEvent = eventsDB[randIndex];
            eventStartTime = Date.now();

            document.getElementById("event-title").innerText = currentEvent.title;
            document.getElementById("event-desc").innerText = currentEvent.desc;
            
            // éš±è—æŒ‰éˆ•å€
            document.getElementById("placeholder").style.display = "block";
            document.getElementById("placeholder").innerText = "ğŸ”´ è«‹å…ˆé»æ“Šéƒ¨ä½(åœ“é»)";
            document.getElementById("action-buttons").style.display = "none";
            document.getElementById("action-buttons").innerHTML = ""; // æ¸…ç©ºæŒ‰éˆ•é˜²æ­¢æ®˜ç•™

            // æ‰£è¡€
            for(let key in currentEvent.effect) {
                stats[key] += currentEvent.effect[key];
            }
            updateDisplay();

            // å•Ÿå‹•å€’æ•¸æ¢å‹•ç•«
            setTimeout(() => {
                timerBar.style.transition = "width 5s linear";
                timerBar.style.width = "0%";
            }, 50);

            eventTimeoutTimer = setTimeout(() => {
                handleEventFail("é€¾æ™‚ï¼");
            }, eventTimeLimit);
        }

        function selectGland(gland) {
            if (!gameActive || processingTurn) return; // é–å®šæœŸé–“ä¸èƒ½é»
            
            document.getElementById("placeholder").style.display = "none";
            let btnArea = document.getElementById("action-buttons");
            btnArea.style.display = "flex";
            btnArea.innerHTML = "";

            const makeBtn = (text, type, color) => 
                `<button class="hormone-btn ${color}" onclick="useHormone('${type}')">${text}</button>`;

            if (gland === 'pituitary') btnArea.innerHTML = makeBtn("ç”Ÿé•·æ¿€ç´ ", "growth", "blue");
            else if (gland === 'thyroid') btnArea.innerHTML = makeBtn("ç”²ç‹€è…ºç´ ", "thyroxine", "blue");
            else if (gland === 'parathyroid') btnArea.innerHTML = makeBtn("å‰¯ç”²ç‹€è…ºç´ ", "parathormone", "orange");
            else if (gland === 'adrenal') btnArea.innerHTML = makeBtn("è…ä¸Šè…ºç´ ", "adrenaline", "orange");
            else if (gland === 'pancreas') {
                btnArea.innerHTML = makeBtn("èƒ°å³¶ç´ (é™)", "insulin", "green") + makeBtn("å‡ç³–ç´ (å‡)", "glucagon", "orange");
            }
        }

        function useHormone(type) {
            if (!gameActive || processingTurn) return; // é–å®šæœŸé–“ä¸èƒ½é»
            processingTurn = true; // é–å®šï¼Œé˜²æ­¢é€£é»
            
            clearTimeout(eventTimeoutTimer);

            if (currentEvent && type === currentEvent.target) {
                // --- ç­”å° ---
                let reactionTime = (Date.now() - eventStartTime) / 1000;
                let points = Math.max(300, Math.floor(1000 - (reactionTime * 150))); 
                score += points;
                showScoreAnim(`+${points}`, true);
                
                fixStats(type); 
                // å»¶é²ä¸€é»é»å†ä¸‹ä¸€é¡Œï¼Œé¿å…è¦–è¦ºéŒ¯äº‚
                setTimeout(triggerNewEvent, 200);

            } else {
                // --- ç­”éŒ¯ ---
                handleEventFail("ç­”éŒ¯ï¼");
            }
        }

        function handleEventFail(reason) {
            if (!gameActive) return;
            processingTurn = true; // é–å®š
            
            score -= 500; 
            if(score < 0) score = 0;
            
            showScoreAnim(`-500 ${reason}`, false);
            fixStats(currentEvent.target); 
            
            setTimeout(triggerNewEvent, 500); // å¤±æ•—å¤šçµ¦ä¸€é»æ™‚é–“çœ‹ç´…å­—
        }

        function fixStats(type) {
            if (type === 'growth') stats.growth = 50; 
            if (type === 'thyroxine') { stats.heart = 50; stats.sugar = 50; }
            if (type === 'parathormone') stats.calcium = 50;
            if (type === 'adrenaline') { stats.heart = 50; stats.sugar = 50; }
            if (type === 'insulin') stats.sugar = 50;
            if (type === 'glucagon') stats.sugar = 50;
        }

        function showScoreAnim(text, isGood) {
            let popup = document.getElementById("score-popup");
            popup.innerText = text;
            popup.style.color = isGood ? "#ffeb3b" : "#ff1744"; 
            
            // å¼·åˆ¶é‡ç¹ªå‹•ç•«
            popup.classList.remove("score-anim");
            void popup.offsetWidth; 
            popup.classList.add("score-anim");
        }

        function endGame() {
            gameActive = false;
            clearInterval(gameLoopTimer);
            clearTimeout(eventTimeoutTimer);
            document.getElementById("overlay").innerHTML = `
                <h1 style="font-size:50px">æ™‚é–“åˆ°ï¼</h1>
                <p style="font-size:30px">æœ€çµ‚æˆç¸¾</p>
                <div style="font-size:100px;color:#ffeb3b;font-weight:bold">${score}</div>
                <button class="start-btn" onclick="startGame()">å†æŒ‘æˆ°ä¸€æ¬¡</button>
            `;
            document.getElementById("overlay").classList.remove("hidden");
        }
    </script>
</body>
</html>